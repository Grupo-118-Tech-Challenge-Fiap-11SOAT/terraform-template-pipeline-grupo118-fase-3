name: SonarCloud Analysis - Reusable

on:
  workflow_call:
    inputs:
      sonar-project-key:
        description: 'SonarCloud project key (e.g., org_repo-name)'
        required: true
        type: string
      sonar-organization:
        description: 'SonarCloud organization key'
        required: true
        type: string
      solution-path:
        description: 'Path to the solution file (e.g., ./src/MySolution.sln)'
        required: true
        type: string
        default: '.'
      test-projects:
        description: 'Space-separated list of test project paths (e.g., "./tests/Project1.Tests/Project1.Tests.csproj ./tests/Project2.Tests/Project2.Tests.csproj")'
        required: true
        type: string
        default: '**/*Tests.csproj'
      dotnet-version:
        description: '.NET SDK version to use'
        required: true
        type: string
        default: '8.0.x'
      build-configuration:
        description: 'Build configuration (Debug/Release)'
        required: true
        type: string
        default: 'Release'
      dockerfile-path:
        description: 'Path to the Dockerfile'
        required: true
        type: string
        default: './Dockerfile'
      image-name:
        description: 'Name of the Docker image to build'
        required: true
        type: string
      sonar-host-url:
        description: 'SonarQube server URL'
        required: false
        type: string
        default: 'https://sonarcloud.io'
      default-branch:
        description: 'Default branch name for the repository'
        required: false
        type: string
        default: 'main'
    secrets:
      SONAR_TOKEN:
        description: 'SonarCloud authentication token'
        required: true
      ACR_USERNAME:
        description: 'Azure Container Registry username'
        required: true
      ACR_PASSWORD:
        description: 'Azure Container Registry password'
        required: true
      ACR_REGISTRY:
        description: 'Azure Container Registry login server'
        required: true

permissions:
  pull-requests: write  # Required for PR comments
  contents: read
  issues: write  # Optional, for issue comments

jobs:
  build-and-analyze:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Shallow clones should be disabled for better analysis
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ inputs.dotnet-version }}
      
      - name: Cache SonarCloud packages
        uses: actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar
      
      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-
      
      - name: Setup SonarCloud Project
        uses: nelsoncanarinho/setup-sonar-action@v1.0.0
        with:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_PROJECT_NAME: ${{ inputs.sonar-project-key }}
          SONAR_PROJECT_KEY: ${{ inputs.sonar-project-key }}
          SONAR_ORGANIZATION: ${{ inputs.sonar-organization }}
          SONAR_HOST_URL: ${{ inputs.sonar-host-url }}

      - name: Install SonarCloud scanner
        run: dotnet tool install --global dotnet-sonarscanner
      
      - name: Restore dependencies
        run: dotnet restore ${{ inputs.solution-path }}
      
      - name: SonarCloud Begin
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          # Common parameters
          SONAR_ARGS=(
            /k:"${{ inputs.sonar-project-key }}"
            /o:"${{ inputs.sonar-organization }}"
            /d:sonar.token="${{ secrets.SONAR_TOKEN }}"
            /d:sonar.host.url="${{ inputs.sonar-host-url }}"
            /d:sonar.cs.opencover.reportsPaths="**/TestResults/**/coverage.opencover.xml"
            /d:sonar.cs.vstest.reportsPaths="**/TestResults/*.trx"
            /d:sonar.coverage.exclusions="**/*Tests/**,**/*Test/**,**/Program.cs,**/Migrations/**,**/*.yml,**/*.yaml"
            /d:sonar.exclusions="**/TestResults/**,**/bin/**,**/obj/**,**/*.yml,**/*.yaml"
            /d:sonar.test.inclusions="**/*Tests/**,**/*Test/**"
            /d:sonar.qualitygate.wait=true
            /d:sonar.newCode.referenceBranch="${{ inputs.default-branch }}"
          )
          
          # Add PR-specific or branch-specific parameters
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "üîç Analyzing Pull Request #${{ github.event.pull_request.number }}"
            SONAR_ARGS+=(
              /d:sonar.pullrequest.key="${{ github.event.pull_request.number }}"
              /d:sonar.pullrequest.branch="${{ github.head_ref }}"
              /d:sonar.pullrequest.base="${{ github.base_ref }}"
              /d:sonar.pullrequest.github.summary_comment="true"
              /d:sonar.pullrequest.github.repository="${{ github.repository }}"
            )
          else
            echo "üîç Analyzing Branch: ${{ github.ref_name }}"
            SONAR_ARGS+=(
              /d:sonar.branch.name="${{ github.ref_name }}"
            )
          fi
          
          # Execute with all parameters
          dotnet sonarscanner begin "${SONAR_ARGS[@]}"
      
      - name: Build
        run: dotnet build ${{ inputs.solution-path }} --no-restore --configuration ${{ inputs.build-configuration }} --no-incremental
      
      - name: Test with Coverage
        run: |
          dotnet test ${{ inputs.test-projects }} \
            --no-build \
            --configuration ${{ inputs.build-configuration }} \
            --verbosity normal \
            --logger "trx" \
            --collect:"XPlat Code Coverage" \
            --results-directory "TestResults" \
            -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=opencover
      
      - name: SonarCloud End
        continue-on-error:  ${{ github.ref != 'refs/heads/main' && (github.event_name != 'pull_request' || github.base_ref != 'main') }}
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: dotnet sonarscanner end /d:sonar.token="${{ secrets.SONAR_TOKEN }}"

  build-docker:
    needs: build-and-analyze
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4    

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ secrets.ACR_REGISTRY }}/${{ inputs.image-name }}
        tags: |
          type=ref,event=branch
          type=sha
          type=schedule,pattern={{date 'YYYYMMDD'}},enable={{is_default_branch}} 
          type=raw,value=latest,enable={{is_default_branch}}
    
    - name: Build Docker image (PR)
      if: github.event_name == 'pull_request'  
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        file: ${{ inputs.dockerfile-path }}

    - name: Log in to Azure Container Registry
      if: (github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main') && github.event_name == 'push'
      uses: docker/login-action@v3
      with:
        registry: ${{ secrets.ACR_REGISTRY }}
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}

    - name: Build Docker image (Main branch)
      if: (github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main') && github.event_name == 'push'
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        file: ${{ inputs.dockerfile-path }}